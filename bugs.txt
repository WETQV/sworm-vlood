

# üêõ –†–æ–µ–≤–æ–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç v2 ‚Äî –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä + –∞–¥–∞–ø—Ç–∞—Ü–∏—è –∫ –∫–ª–∞—Å—Å–∞–º

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –∏ –ø–æ—á–µ–º—É

```
–ü–†–û–ë–õ–ï–ú–´ v1                          –†–ï–®–ï–ù–ò–ï v2
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ     ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
–û–¥–∏–Ω target_player                ‚Üí  –ú–∞—Å—Å–∏–≤ –∏–≥—Ä–æ–∫–æ–≤ + threat-—Å–∏—Å—Ç–µ–º–∞
–í—Å–µ —Å–ª–∞–π–º—ã –Ω–∞ –æ–¥–Ω–æ–≥–æ              ‚Üí  –û—Ç—Ä—è–¥—ã (squads) –ø–æ –∏–≥—Ä–æ–∫–∞–º
–û–¥–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–∞ –≤—Å–µ—Ö            ‚Üí  –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ü–û –û–¢–†–Ø–î–£
–ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–ª–∞—Å—Å –∏–≥—Ä–æ–∫–∞       ‚Üí  –ü–æ–≤–µ–¥–µ–Ω–∏–µ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –∫ –∫–ª–∞—Å—Å—É
–ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –∞—Ç–∞–∫–∏           ‚Üí  –¢–æ–∫–µ–Ω—ã –ü–û –ö–ê–ñ–î–û–ú–£ –∏–≥—Ä–æ–∫—É
–û–¥–∏–Ω–∞–∫–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ              ‚Üí  vs –ú–µ—á–Ω–∏–∫ ‚â† vs –ú–∞–≥ ‚â† vs –õ—É—á–Ω–∏–∫
```

```
–ê–†–•–ò–¢–ï–ö–¢–£–†–ê v2

SwarmManager
‚îú‚îÄ‚îÄ –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
‚îú‚îÄ‚îÄ ThreatTable (–æ—Ü–µ–Ω–∫–∞ —É–≥—Ä–æ–∑—ã –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞)
‚îú‚îÄ‚îÄ Squad-—Å–∏—Å—Ç–µ–º–∞ (–∫–∞–∫–∏–µ —Å–ª–∞–π–º—ã ‚Üí –Ω–∞ –∫–∞–∫–æ–≥–æ –∏–≥—Ä–æ–∫–∞)
‚îÇ   ‚îú‚îÄ‚îÄ Squad –¥–ª—è Player_1 ‚Üí —Å–≤–æ—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, —Å–≤–æ–∏ —Ä–æ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ Squad –¥–ª—è Player_2 ‚Üí —Å–≤–æ—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è, —Å–≤–æ–∏ —Ä–æ–ª–∏
‚îÇ   ‚îú‚îÄ‚îÄ Squad –¥–ª—è Player_3 ‚Üí ...
‚îÇ   ‚îî‚îÄ‚îÄ Squad –¥–ª—è Player_4 ‚Üí ...
‚îú‚îÄ‚îÄ –¢–æ–∫–µ–Ω—ã –∞—Ç–∞–∫–∏ –ü–û –ö–ê–ñ–î–û–ú–£ –∏–≥—Ä–æ–∫—É
‚îú‚îÄ‚îÄ –†–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –æ—Ç—Ä—è–¥–æ–≤ (–∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥)
‚îî‚îÄ‚îÄ –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Ä–æ–ª–µ–π –∫ –∫–ª–∞—Å—Å—É —Ü–µ–ª–∏

SlimeAI
‚îú‚îÄ‚îÄ –ó–Ω–∞–µ—Ç –°–í–û–ï–ì–û —Ü–µ–ª–µ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞ (–Ω–∞–∑–Ω–∞—á–µ–Ω –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º)
‚îú‚îÄ‚îÄ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ (vs –º–µ—á–Ω–∏–∫ ‚Äî –¥–∞–ª—å—à–µ, vs –º–∞–≥ ‚Äî –±–ª–∏–∂–µ)
‚îú‚îÄ‚îÄ –£–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç AoE —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π
‚îú‚îÄ‚îÄ –ó–∏–≥–∑–∞–≥-–ø–æ–¥—Ö–æ–¥ –∫ –¥–∞–ª—å–Ω–∏–∫–∞–º
‚îî‚îÄ‚îÄ Boids —Ç–æ–ª—å–∫–æ —Å—Ä–µ–¥–∏ –°–í–û–ï–ì–û –æ—Ç—Ä—è–¥–∞ + –æ–±—â–µ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
```

---

## –§–∞–π–ª 0 ‚Äî `player_info.gd`

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∞ –∏–≥—Ä–æ–∫–µ, –∫–æ—Ç–æ—Ä—ã–π —Å–ª–∞–π–º—ã –±—É–¥—É—Ç —á–∏—Ç–∞—Ç—å. –ë–µ–∑ –Ω–µ–≥–æ –ò–ò –Ω–µ –∑–Ω–∞–µ—Ç, —Å –∫–µ–º –∏–º–µ–µ—Ç –¥–µ–ª–æ.

```gdscript
# scripts/components/player_info.gd
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ö–æ–º–ø–æ–Ω–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤–µ—à–∞–µ—Ç—Å—è –Ω–∞ –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞.
# SlimeAI –∏ SwarmManager —á–∏—Ç–∞—é—Ç –∏–∑ –Ω–µ–≥–æ –¥–∞–Ω–Ω—ã–µ.
# –°–∞–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–µ—à–∞–µ—Ç ‚Äî —Ç–æ–ª—å–∫–æ –æ—Ç–¥–∞—ë—Ç –∏–Ω—Ñ—É.
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
extends Node
class_name PlayerInfo

# ‚îÄ‚îÄ –ö–ª–∞—Å—Å—ã –∏–≥—Ä–æ–∫–∞ ‚îÄ‚îÄ
enum PlayerClass {
    WARRIOR,   # –±–ª–∏–∂–Ω–∏–π –±–æ–π, —Ç–∞–Ω–∫–æ–≤—ã–π
    RANGER,    # –¥–∞–ª—å–Ω–∏–π –±–æ–π, –º–æ–±–∏–ª—å–Ω—ã–π
    MAGE,      # –¥–∞–ª—å–Ω–∏–π –±–æ–π, —Å—Ç–µ–∫–ª—è–Ω–Ω—ã–π
    PALADIN    # –±–ª–∏–∂–Ω–∏–π –±–æ–π, –ø–æ–¥–¥–µ—Ä–∂–∫–∞
}

# ‚îÄ‚îÄ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ‚îÄ‚îÄ

## –ö–ª–∞—Å—Å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ‚Äî –∑–∞–¥–∞—ë—Ç—Å—è –≤ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–µ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ —Å—Ü–µ–Ω—ã
@export var player_class: PlayerClass = PlayerClass.WARRIOR

## –°—Å—ã–ª–∫–∞ –Ω–∞ HealthComponent (–¥–ª—è —á—Ç–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ HP)
@export var health_component_path: NodePath = "HealthComponent"

# ‚îÄ‚îÄ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π ‚îÄ‚îÄ
# –≠—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–∫—Ä–∏–ø—Ç –∏–≥—Ä–æ–∫–∞,
# –∫–æ–≥–¥–∞ –æ–Ω –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å.

## –ê–∫—Ç–∏–≤–Ω–∞ –ª–∏ —Å–µ–π—á–∞—Å –∫–∞–∫–∞—è-—Ç–æ –æ–ø–∞—Å–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å?
var is_ability_active: bool = false

## –¶–µ–Ω—Ç—Ä –æ–ø–∞—Å–Ω–æ–π –∑–æ–Ω—ã (–º–∏—Ä–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)
var ability_zone_center: Vector2 = Vector2.ZERO

## –†–∞–¥–∏—É—Å –æ–ø–∞—Å–Ω–æ–π –∑–æ–Ω—ã (0 = –Ω–µ—Ç –∑–æ–Ω—ã)
var ability_zone_radius: float = 0.0

## –¢–∏–ø –æ–ø–∞—Å–Ω–æ—Å—Ç–∏: "melee_aoe", "ranged_aoe", "shield", "projectile"
var ability_type: String = ""

# ‚îÄ‚îÄ –°—á—ë—Ç—á–∏–∫ —É–±–∏–π—Å—Ç–≤ (–¥–ª—è –æ—Ü–µ–Ω–∫–∏ —É–≥—Ä–æ–∑—ã) ‚îÄ‚îÄ

## –°–∫–æ–ª—å–∫–æ —Å–ª–∞–π–º–æ–≤ —ç—Ç–æ—Ç –∏–≥—Ä–æ–∫ —É–±–∏–ª –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–µ–∫—É–Ω–¥
var recent_kills: int = 0
var _kill_timestamps: Array[float] = []

## –û–∫–Ω–æ –ø–æ–¥—Å—á—ë—Ç–∞ (—Å–µ–∫—É–Ω–¥—ã)
@export var kill_window: float = 10.0

# ‚îÄ‚îÄ –°—Å—ã–ª–∫–∏ ‚îÄ‚îÄ
var _health: Node = null

func _ready() -> void:
    if has_node(health_component_path):
        _health = get_node(health_component_path)

func _process(delta: float) -> void:
    _update_recent_kills()

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ü–£–ë–õ–ò–ß–ù–´–ï –ú–ï–¢–û–î–´ (—á–∏—Ç–∞–µ—Ç SwarmManager / SlimeAI)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

## –ë–ª–∏–∂–Ω–∏–π –∏–ª–∏ –¥–∞–ª—å–Ω–∏–π –∫–ª–∞—Å—Å?
func is_melee() -> bool:
    return player_class in [PlayerClass.WARRIOR, PlayerClass.PALADIN]

func is_ranged() -> bool:
    return player_class in [PlayerClass.RANGER, PlayerClass.MAGE]

## –û—Ç–Ω–æ—à–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ HP –∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É (0.0 - 1.0)
func get_hp_ratio() -> float:
    if _health and _health.has_method("get_hp_ratio"):
        return _health.get_hp_ratio()
    # –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –µ—Å–ª–∏ HealthComponent —Ö—Ä–∞–Ω–∏—Ç hp/max_hp –Ω–∞–ø—Ä—è–º—É—é
    if _health and "hp" in _health and "max_hp" in _health:
        if _health.max_hp > 0:
            return float(_health.hp) / float(_health.max_hp)
    return 1.0

## –ü–æ–∑–∏—Ü–∏—è –∏–≥—Ä–æ–∫–∞ (—É–¥–æ–±—Å—Ç–≤–æ)
func get_position() -> Vector2:
    return get_parent().global_position

## –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —É–±–∏–π—Å—Ç–≤–æ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ—Ä—Ç–∏ —Å–ª–∞–π–º–∞)
func register_kill() -> void:
    _kill_timestamps.append(Time.get_ticks_msec() / 1000.0)

## –û–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ (—É–±—Ä–∞—Ç—å —Å—Ç–∞—Ä—ã–µ)
func _update_recent_kills() -> void:
    var now := Time.get_ticks_msec() / 1000.0
    _kill_timestamps = _kill_timestamps.filter(
        func(t): return now - t < kill_window
    )
    recent_kills = _kill_timestamps.size()

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ú–ï–¢–û–î–´ –î–õ–Ø –°–ö–†–ò–ü–¢–ê –ò–ì–†–û–ö–ê
# (–≤—ã–∑—ã–≤–∞—é—Ç—Å—è –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞ –∫–ª–∞—Å—Å–∞ –ø—Ä–∏ –∫–∞—Å—Ç–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

## –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∞—Å–Ω—É—é –∑–æ–Ω—É
## –ü—Ä–∏–º–µ—Ä: –º–µ—á–Ω–∏–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—Ä—É–≥–æ–≤–æ–π —É–¥–∞—Ä
func activate_danger_zone(center: Vector2, radius: float, type: String = "melee_aoe") -> void:
    is_ability_active = true
    ability_zone_center = center
    ability_zone_radius = radius
    ability_type = type

## –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∞—Å–Ω—É—é –∑–æ–Ω—É
func deactivate_danger_zone() -> void:
    is_ability_active = false
    ability_zone_radius = 0.0
    ability_type = ""
```

–î–æ–±–∞–≤—å –≤ —Å–∫—Ä–∏–ø—Ç –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Å–∞ –≤—ã–∑–æ–≤—ã `activate_danger_zone` / `deactivate_danger_zone`:

```gdscript
# –ü—Ä–∏–º–µ—Ä: warrior.gd –ø—Ä–∏ –∫—Ä—É–≥–æ–≤–æ–º —É–¥–∞—Ä–µ
func special_attack():
    var info = $PlayerInfo as PlayerInfo
    info.activate_danger_zone(global_position, 80.0, "melee_aoe")
    # ... –∞–Ω–∏–º–∞—Ü–∏—è, —É—Ä–æ–Ω ...
    await get_tree().create_timer(0.5).timeout
    info.deactivate_danger_zone()

# –ü—Ä–∏–º–µ—Ä: mage.gd –ø—Ä–∏ –º–µ—Ç–µ–æ—Ä–∏—Ç–µ
func cast_meteor(target_pos: Vector2):
    var info = $PlayerInfo as PlayerInfo
    info.activate_danger_zone(target_pos, 120.0, "ranged_aoe")
    await get_tree().create_timer(2.0).timeout  # –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ—Ç–µ–æ—Ä–∏—Ç–∞
    info.deactivate_danger_zone()

# –ü—Ä–∏–º–µ—Ä: paladin.gd –ø—Ä–∏ –∫—É–ø–æ–ª–µ
func shield_dome():
    var info = $PlayerInfo as PlayerInfo
    info.activate_danger_zone(global_position, 100.0, "shield")
    await get_tree().create_timer(4.0).timeout
    info.deactivate_danger_zone()
```

---

## –§–∞–π–ª 1 ‚Äî `swarm_manager.gd` (v2)

–ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω –¥–ª—è –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–∞.

```gdscript
# scripts/enemies/swarm_manager.gd
extends Node

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –†–û–ï–í–û–ô –ú–ï–ù–ï–î–ñ–ï–† v2
# –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 1-4 –∏–≥—Ä–æ–∫–æ–≤, –∞–¥–∞–ø—Ç–∞—Ü–∏—è –∫ –∫–ª–∞—Å—Å–∞–º,
# –æ—Ç—Ä—è–¥—ã (squads), threat-—Å–∏—Å—Ç–µ–º–∞
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ü–ï–†–ï–ß–ò–°–õ–ï–ù–ò–Ø
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

enum Strategy { SOLO, PACK, SWARM, HORDE }

enum Role {
    RUSHER,
    FLANKER,
    ORBITER,
    WAITER,
    RETREATER
}

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ù–ê–°–¢–†–û–ô–ö–ò
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

## –ö–∞–∫ —á–∞—Å—Ç–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å –æ—Ç—Ä—è–¥—ã –∏ —Ä–æ–ª–∏
@export var reassign_interval: float = 0.6

## –ë–∞–∑–æ–≤–æ–µ —á–∏—Å–ª–æ –∞—Ç–∞–∫—É—é—â–∏—Ö –Ω–∞ –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
@export var base_attackers_per_player: int = 2

## –ú–∞–∫—Å–∏–º—É–º –∞—Ç–∞–∫—É—é—â–∏—Ö –Ω–∞ –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞
@export var max_attackers_per_player: int = 4

## –ë–ª–∏–∂–Ω—è—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è
@export var close_range: float = 80.0

## –°—Ä–µ–¥–Ω—è—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è
@export var medium_range: float = 200.0

## –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –æ—Ç—Ä—è–¥–∞ (—á—Ç–æ–±—ã –Ω–∏ –æ–¥–∏–Ω –∏–≥—Ä–æ–∫ –Ω–µ –æ—Å—Ç–∞–ª—Å—è –±–µ–∑ –≤–Ω–∏–º–∞–Ω–∏—è)
@export var min_squad_size: int = 1

# ‚îÄ‚îÄ‚îÄ –í–µ—Å–∞ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —É–≥—Ä–æ–∑—ã ‚îÄ‚îÄ‚îÄ

## –í–µ—Å –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ (–±–ª–∏–∂–µ = –æ–ø–∞—Å–Ω–µ–µ –¥–ª—è —Å–ª–∞–π–º–æ–≤ ‚Üí –±–æ–ª—å—à–µ –≤–Ω–∏–º–∞–Ω–∏—è)
@export var threat_weight_distance: float = 1.0

## –í–µ—Å —É—Ä–æ–Ω–∞ (–∫—Ç–æ –±–æ–ª—å—à–µ —É–±–∏–≤–∞–µ—Ç ‚Üí –±–æ–ª—å—à–µ —É–≥—Ä–æ–∑–∞)
@export var threat_weight_damage: float = 1.5

## –í–µ—Å –Ω–∏–∑–∫–æ–≥–æ HP (—Ä–∞–Ω–µ–Ω—ã–π ‚Üí –ª–µ–≥—á–µ –¥–æ–±–∏—Ç—å ‚Üí –≤—ã—à–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
@export var threat_weight_low_hp: float = 2.0

## –í–µ—Å –∫–ª–∞—Å—Å–∞ (–º–∞–≥/–ª—É—á–Ω–∏–∫ –æ–ø–∞—Å–Ω–µ–µ –¥–ª—è —Ä–æ—è ‚Üí –∞—Ç–∞–∫—É–µ–º –ø–µ—Ä–≤—ã–º)
@export var threat_weight_class: float = 1.2

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –°–û–°–¢–û–Ø–ù–ò–ï
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

## –í—Å–µ –∂–∏–≤—ã–µ —Å–ª–∞–π–º—ã
var slimes: Array[CharacterBody2D] = []

## –í—Å–µ –∏–≥—Ä–æ–∫–∏ –≤ –∏–≥—Ä–µ
var players: Array[CharacterBody2D] = []

## –û—Ç—Ä—è–¥: player_id ‚Üí –º–∞—Å—Å–∏–≤ —Å–ª–∞–π–º–æ–≤
## player_id = –∏–Ω–¥–µ–∫—Å –≤ –º–∞—Å—Å–∏–≤–µ players
var squads: Dictionary = {}  # { int: Array[CharacterBody2D] }

## –°—Ç—Ä–∞—Ç–µ–≥–∏—è –∫–∞–∂–¥–æ–≥–æ –æ—Ç—Ä—è–¥–∞
var squad_strategies: Dictionary = {}  # { int: Strategy }

## –¢–æ–∫–µ–Ω—ã –∞—Ç–∞–∫–∏ PER PLAYER
var _attack_tokens: Dictionary = {}  # { int: Array[CharacterBody2D] }

## –£–≥—Ä–æ–∑—ã PER PLAYER
var _threat_scores: Dictionary = {}  # { int: float }

## –¢–∞–π–º–µ—Ä
var _reassign_timer: float = 0.0

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ñ–ò–ó–ù–ï–ù–ù–´–ô –¶–ò–ö–õ
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

func _ready() -> void:
    add_to_group("swarm_manager")
    _find_players()


func _physics_process(delta: float) -> void:
    _reassign_timer -= delta
    if _reassign_timer <= 0.0:
        _reassign_timer = reassign_interval
        _find_players()
        _calculate_threats()
        _assign_squads()
        _assign_roles_for_all_squads()
        _cleanup_all_tokens()

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

func register_slime(slime: CharacterBody2D) -> void:
    if slime not in slimes:
        slimes.append(slime)


func unregister_slime(slime: CharacterBody2D) -> void:
    slimes.erase(slime)
    # –£–±–∏—Ä–∞–µ–º –∏–∑ –≤—Å–µ—Ö –æ—Ç—Ä—è–¥–æ–≤ –∏ —Ç–æ–∫–µ–Ω–æ–≤
    for pid in squads:
        squads[pid].erase(slime)
    for pid in _attack_tokens:
        _attack_tokens[pid].erase(slime)

    # –°–æ–æ–±—â–∞–µ–º –∏–≥—Ä–æ–∫–∞–º –æ —É–±–∏–π—Å—Ç–≤–µ (–¥–ª—è threat-—Å–∏—Å—Ç–µ–º—ã)
    # –¢—É—Ç –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å, –∫—Ç–æ —É–±–∏–ª ‚Äî –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –∏–∑ HealthComponent
    # –ü–æ–∫–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º, register_kill –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –¥—Ä—É–≥–æ–≥–æ –º–µ—Å—Ç–∞


func _find_players() -> void:
    players.clear()
    var found := get_tree().get_nodes_in_group("player")
    for p in found:
        if p is CharacterBody2D and is_instance_valid(p):
            players.append(p as CharacterBody2D)

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è –Ω–æ–≤—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
    for i in range(players.size()):
        if i not in squads:
            squads[i] = []
        if i not in _attack_tokens:
            _attack_tokens[i] = []
        if i not in _threat_scores:
            _threat_scores[i] = 0.0

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# THREAT-–°–ò–°–¢–ï–ú–ê
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –û—Ü–µ–Ω–∏–≤–∞–µ–º –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞: –Ω–∞—Å–∫–æ–ª—å–∫–æ –æ–Ω "–≤–∞–∂–Ω–∞—è —Ü–µ–ª—å".
# –ß–µ–º –≤—ã—à–µ threat ‚Üí —Ç–µ–º –±–æ–ª—å—à–µ —Å–ª–∞–π–º–æ–≤ –Ω–∞ –Ω–µ–≥–æ –≤—ã–¥–µ–ª—è–µ–º.
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

func _calculate_threats() -> void:
    if players.is_empty() or slimes.is_empty():
        return

    var swarm_center := _get_swarm_center()

    for i in range(players.size()):
        var player := players[i]
        var info := _get_player_info(player)

        var threat := 0.0

        # ‚îÄ‚îÄ –§–∞–∫—Ç–æ—Ä –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ ‚îÄ‚îÄ
        # –ß–µ–º –±–ª–∏–∂–µ –∏–≥—Ä–æ–∫ –∫ —Ü–µ–Ω—Ç—Ä—É —Ä–æ—è, —Ç–µ–º –æ–Ω "–æ–ø–∞—Å–Ω–µ–µ"
        var dist := player.global_position.distance_to(swarm_center)
        var dist_factor := clampf(1.0 - (dist / 600.0), 0.1, 1.0)
        threat += dist_factor * threat_weight_distance

        if info:
            # ‚îÄ‚îÄ –§–∞–∫—Ç–æ—Ä —É—Ä–æ–Ω–∞ ‚îÄ‚îÄ
            # –ö—Ç–æ —É–±–∏–≤–∞–µ—Ç –±–æ–ª—å—à–µ —Å–ª–∞–π–º–æ–≤ ‚Äî —Ç–æ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ
            var kill_factor := clampf(info.recent_kills / 5.0, 0.0, 1.0)
            threat += kill_factor * threat_weight_damage

            # ‚îÄ‚îÄ –§–∞–∫—Ç–æ—Ä –Ω–∏–∑–∫–æ–≥–æ HP ‚îÄ‚îÄ
            # –†–∞–Ω–µ–Ω–æ–≥–æ –ª–µ–≥—á–µ –¥–æ–±–∏—Ç—å ‚Üí –ø–æ–≤—ã—à–∞–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
            var hp_ratio := info.get_hp_ratio()
            var low_hp_factor := clampf(1.0 - hp_ratio, 0.0, 1.0)
            threat += low_hp_factor * threat_weight_low_hp

            # ‚îÄ‚îÄ –§–∞–∫—Ç–æ—Ä –∫–ª–∞—Å—Å–∞ ‚îÄ‚îÄ
            # –°—Ç–µ–∫–ª—è–Ω–Ω—ã–µ –ø—É—à–∫–∏ ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ —Ü–µ–ª–∏
            var class_factor := _get_class_priority(info.player_class)
            threat += class_factor * threat_weight_class

        _threat_scores[i] = threat


## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫–ª–∞—Å—Å–∞ (–≤—ã—à–µ = –∞—Ç–∞–∫—É–µ–º –ø–µ—Ä–≤—ã–º)
func _get_class_priority(pclass: int) -> float:
    match pclass:
        PlayerInfo.PlayerClass.MAGE:
            return 1.0    # —Å—Ç–µ–∫–ª—è–Ω–Ω–∞—è –ø—É—à–∫–∞ ‚Üí —É–±–∏—Ç—å –ø–µ—Ä–≤—ã–º
        PlayerInfo.PlayerClass.RANGER:
            return 0.8    # —Ç–æ–∂–µ –±–æ–ª—å–Ω–æ –±—å—ë—Ç
        PlayerInfo.PlayerClass.WARRIOR:
            return 0.5    # —Ç–∞–Ω–∫—É–µ—Ç, –Ω–æ –Ω–µ —Ç–∞–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ–Ω
        PlayerInfo.PlayerClass.PALADIN:
            return 0.3    # —Ç–∞–Ω–∫-–ø–æ–¥–¥–µ—Ä–∂–∫–∞ ‚Üí –≤ –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—á–µ—Ä–µ–¥—å
    return 0.5

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ü–û –û–¢–†–Ø–î–ê–ú
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ö–∞–∂–¥—ã–π —Å–ª–∞–π–º –Ω–∞–∑–Ω–∞—á–∞–µ—Ç—Å—è –Ω–∞ –æ–¥–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞.
# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–∞–π–º–æ–≤ –≤ –æ—Ç—Ä—è–¥–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ —É–≥—Ä–æ–∑–µ –∏–≥—Ä–æ–∫–∞.
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

func _assign_squads() -> void:
    if players.is_empty() or slimes.is_empty():
        return

    # ‚îÄ‚îÄ –®–∞–≥ 1: –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–≤–æ—Ç—ã ‚îÄ‚îÄ
    var total_threat := 0.0
    for pid in range(players.size()):
        total_threat += _threat_scores.get(pid, 1.0)

    if total_threat < 0.01:
        total_threat = 1.0

    var quotas: Dictionary = {}  # pid ‚Üí –∂–µ–ª–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä –æ—Ç—Ä—è–¥–∞
    var total_slimes := slimes.size()

    for pid in range(players.size()):
        var ratio: float = _threat_scores.get(pid, 1.0) / total_threat
        var quota: int = max(min_squad_size, roundi(ratio * total_slimes))
        quotas[pid] = quota

    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º, —á—Ç–æ–±—ã —Å—É–º–º–∞ –∫–≤–æ—Ç = total_slimes
    var quota_sum := 0
    for pid in quotas:
        quota_sum += quotas[pid]

    # –ï—Å–ª–∏ –∫–≤–æ—Ç –±–æ–ª—å—à–µ —á–µ–º —Å–ª–∞–π–º–æ–≤ ‚Äî —É—Ä–µ–∂–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
    if quota_sum > total_slimes:
        for pid in quotas:
            quotas[pid] = max(1, roundi(float(quotas[pid]) / quota_sum * total_slimes))

    # ‚îÄ‚îÄ –®–∞–≥ 2: –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ—Ç—Ä—è–¥—ã ‚îÄ‚îÄ
    for pid in squads:
        squads[pid] = []

    # ‚îÄ‚îÄ –®–∞–≥ 3: –Ω–∞–∑–Ω–∞—á–∞–µ–º —Å–ª–∞–π–º–æ–≤ ‚îÄ‚îÄ
    # –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–∞–π–º–∞ —Å—á–∏—Ç–∞–µ–º "–æ—Ü–µ–Ω–∫—É –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è" –∫ –∫–∞–∂–¥–æ–º—É –∏–≥—Ä–æ–∫—É.
    # –≠—Ç–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è: –±–ª–∏–∑–æ—Å—Ç—å –∫ –∏–≥—Ä–æ–∫—É √ó —É–≥—Ä–æ–∑–∞ –∏–≥—Ä–æ–∫–∞.
    # –ó–∞—Ç–µ–º –∂–∞–¥–Ω–æ –Ω–∞–∑–Ω–∞—á–∞–µ–º, –ø–æ–∫–∞ –∫–≤–æ—Ç—ã –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã.

    var unassigned := slimes.duplicate()
    var assigned_count: Dictionary = {}
    for pid in range(players.size()):
        assigned_count[pid] = 0

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–≥—Ä–æ–∫–æ–≤ –ø–æ —É–±—ã–≤–∞–Ω–∏—é —É–≥—Ä–æ–∑—ã (—Å–Ω–∞—á–∞–ª–∞ –Ω–∞–±–∏—Ä–∞–µ–º –æ—Ç—Ä—è–¥
    # –¥–ª—è —Å–∞–º–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–≥–æ)
    var sorted_pids: Array[int] = []
    for pid in range(players.size()):
        sorted_pids.append(pid)
    sorted_pids.sort_custom(func(a, b):
        return _threat_scores.get(a, 0) > _threat_scores.get(b, 0)
    )

    for pid in sorted_pids:
        var player := players[pid]
        var player_pos := player.global_position
        var quota: int = quotas.get(pid, 1)

        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Å–ª–∞–π–º–æ–≤ –ø–æ –±–ª–∏–∑–æ—Å—Ç–∏ –∫ —ç—Ç–æ–º—É –∏–≥—Ä–æ–∫—É
        unassigned.sort_custom(func(a: CharacterBody2D, b: CharacterBody2D) -> bool:
            return a.global_position.distance_squared_to(player_pos) \
                 < b.global_position.distance_squared_to(player_pos)
        )

        var to_assign := mini(quota, unassigned.size())
        for j in range(to_assign):
            var slime := unassigned[j]
            if pid not in squads:
                squads[pid] = []
            squads[pid].append(slime)

            # –°–æ–æ–±—â–∞–µ–º —Å–ª–∞–π–º—É –µ–≥–æ –Ω–æ–≤—É—é —Ü–µ–ª—å
            var ai := _get_ai(slime)
            if ai:
                ai.assigned_target = player
                ai.assigned_player_id = pid

        # –£–±–∏—Ä–∞–µ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö
        for j in range(to_assign - 1, -1, -1):
            unassigned.remove_at(j)

    # –û—Å—Ç–∞–≤—à–∏–µ—Å—è (–µ—Å–ª–∏ –µ—Å—Ç—å) ‚Äî –Ω–∞ —Å–∞–º–æ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–≥–æ
    if not unassigned.is_empty() and not sorted_pids.is_empty():
        var fallback_pid: int = sorted_pids[0]
        for slime in unassigned:
            if fallback_pid not in squads:
                squads[fallback_pid] = []
            squads[fallback_pid].append(slime)
            var ai := _get_ai(slime)
            if ai:
                ai.assigned_target = players[fallback_pid]
                ai.assigned_player_id = fallback_pid

    # ‚îÄ‚îÄ –®–∞–≥ 4: –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –∫–∞–∂–¥–æ–≥–æ –æ—Ç—Ä—è–¥–∞ ‚îÄ‚îÄ
    for pid in squads:
        var squad_size: int = squads[pid].size()
        squad_strategies[pid] = _size_to_strategy(squad_size)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï –†–û–õ–ï–ô (–ü–û –û–¢–†–Ø–î–ê–ú)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

func _assign_roles_for_all_squads() -> void:
    for pid in squads:
        if pid >= players.size():
            continue
        var player := players[pid]
        var squad: Array = squads[pid]
        var strategy: Strategy = squad_strategies.get(pid, Strategy.SOLO)
        var info := _get_player_info(player)

        _assign_roles_for_squad(squad, player, strategy, info)


func _assign_roles_for_squad(
    squad: Array,
    player: CharacterBody2D,
    strategy: Strategy,
    info: PlayerInfo
) -> void:
    if squad.is_empty():
        return

    var player_pos := player.global_position
    var is_melee := info.is_melee() if info else true

    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –¥–æ –°–í–û–ï–ì–û –∏–≥—Ä–æ–∫–∞
    squad.sort_custom(func(a: CharacterBody2D, b: CharacterBody2D) -> bool:
        return a.global_position.distance_squared_to(player_pos) \
             < b.global_position.distance_squared_to(player_pos)
    )

    # ‚îÄ‚îÄ –í—ã–±–∏—Ä–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–æ–ª–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç
    #    —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ + –∫–ª–∞—Å—Å–∞ —Ü–µ–ª–∏ ‚îÄ‚îÄ

    var role_plan: Array = _get_role_plan(strategy, is_melee, squad.size())

    for i in range(squad.size()):
        var ai := _get_ai(squad[i])
        if not ai:
            continue
        var role: Role = role_plan[mini(i, role_plan.size() - 1)]
        ai.set_role(role, i)


## –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –º–∞—Å—Å–∏–≤ —Ä–æ–ª–µ–π –¥–ª—è –æ—Ç—Ä—è–¥–∞.
## –£—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—é (—Å–∫–æ–ª—å–∫–æ —Å–ª–∞–π–º–æ–≤) –∏ –∫–ª–∞—Å—Å —Ü–µ–ª–∏.
func _get_role_plan(strategy: Strategy, target_is_melee: bool, count: int) -> Array:
    var plan: Array = []

    match strategy:
        Strategy.SOLO:
            if target_is_melee:
                # –ü—Ä–æ—Ç–∏–≤ –º–µ—á–Ω–∏–∫–∞/–ø–∞–ª–∞–¥–∏–Ω–∞: –æ–±–∞ —Ñ–ª–∞–Ω–∫–∏—Ä—É—é—Ç
                # –ù–µ –ª–µ–∑–µ–º –≤ –ª–æ–± ‚Äî –æ–±—Ö–æ–¥–∏–º
                for i in range(count):
                    plan.append(Role.FLANKER)
            else:
                # –ü—Ä–æ—Ç–∏–≤ –¥–∞–ª—å–Ω–∏–∫–∞: —Ä–∞—à–∏–º ‚Äî –Ω—É–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –¥–∏—Å—Ç–∞–Ω—Ü–∏—é
                for i in range(count):
                    plan.append(Role.RUSHER)

        Strategy.PACK:
            if target_is_melee:
                # vs –º–µ—á–Ω–∏–∫: 1 —Ä–∞—à + –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–ª–∞–Ω–∫/–æ—Ä–±–∏—Ç
                plan.append(Role.RUSHER)
                for i in range(1, count):
                    plan.append(Role.FLANKER if i % 2 == 0 else Role.ORBITER)
            else:
                # vs –¥–∞–ª—å–Ω–∏–∫: –±–æ–ª—å—à–µ —Ä–∞—à–µ—Ä–æ–≤, –Ω—É–∂–Ω–æ –ø—Ä–æ—Ä–≤–∞—Ç—å—Å—è
                var rushers := ceili(count * 0.6)
                for i in range(rushers):
                    plan.append(Role.RUSHER)
                for i in range(rushers, count):
                    plan.append(Role.FLANKER)

        Strategy.SWARM:
            if target_is_melee:
                # vs –º–µ—á–Ω–∏–∫: –º–∞–ª–æ —Ä–∞—à–µ—Ä–æ–≤, –º–Ω–æ–≥–æ —Ñ–ª–∞–Ω–∫–µ—Ä–æ–≤ –∏ –æ—Ä–±–∏—Ç–µ—Ä–æ–≤
                # –ò–∑–º–∞—Ç—ã–≤–∞–µ–º, –Ω–µ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º—Å—è –ø–æ–¥ AoE
                var rushers := ceili(count * 0.2)
                var flankers := ceili(count * 0.4)
                for i in range(rushers):
                    plan.append(Role.RUSHER)
                for i in range(flankers):
                    plan.append(Role.FLANKER)
                for i in range(rushers + flankers, count):
                    plan.append(Role.ORBITER)
            else:
                # vs –¥–∞–ª—å–Ω–∏–∫: –º–Ω–æ–≥–æ —Ä–∞—à–µ—Ä–æ–≤, –æ–∫—Ä—É–∂–µ–Ω–∏–µ
                var rushers := ceili(count * 0.4)
                var flankers := ceili(count * 0.35)
                for i in range(rushers):
                    plan.append(Role.RUSHER)
                for i in range(flankers):
                    plan.append(Role.FLANKER)
                for i in range(rushers + flankers, count):
                    plan.append(Role.ORBITER)

        Strategy.HORDE:
            if target_is_melee:
                # vs –º–µ—á–Ω–∏–∫: –æ—Ä–±–∏—Ç–µ—Ä—ã + —Ñ–ª–∞–Ω–∫–µ—Ä—ã + –æ–∂–∏–¥–∞—é—â–∏–µ, –º–∞–ª–æ —Ä–∞—à–µ—Ä–æ–≤
                var rushers := ceili(count * 0.15)
                var flankers := ceili(count * 0.30)
                var orbiters := ceili(count * 0.30)
                for i in range(rushers):
                    plan.append(Role.RUSHER)
                for i in range(flankers):
                    plan.append(Role.FLANKER)
                for i in range(orbiters):
                    plan.append(Role.ORBITER)
                for i in range(rushers + flankers + orbiters, count):
                    plan.append(Role.WAITER)
            else:
                # vs –¥–∞–ª—å–Ω–∏–∫: –¥–∞–≤–∏–º –º–∞—Å—Å–æ–π
                var rushers := ceili(count * 0.35)
                var flankers := ceili(count * 0.30)
                var orbiters := ceili(count * 0.20)
                for i in range(rushers):
                    plan.append(Role.RUSHER)
                for i in range(flankers):
                    plan.append(Role.FLANKER)
                for i in range(orbiters):
                    plan.append(Role.ORBITER)
                for i in range(rushers + flankers + orbiters, count):
                    plan.append(Role.WAITER)

    # –î–æ–±–∏–≤–∞–µ–º –¥–æ –Ω—É–∂–Ω–æ–π –¥–ª–∏–Ω—ã, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–µ —Ö–≤–∞—Ç–∏–ª–æ
    while plan.size() < count:
        plan.append(Role.WAITER)

    return plan

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –¢–û–ö–ï–ù–´ –ê–¢–ê–ö–ò (PER PLAYER)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

func request_attack_token(slime: CharacterBody2D, player_id: int) -> bool:
    if player_id not in _attack_tokens:
        _attack_tokens[player_id] = []

    var tokens: Array = _attack_tokens[player_id]
    if slime in tokens:
        return true

    var max_tokens := _get_max_attackers_for_player(player_id)
    if tokens.size() < max_tokens:
        tokens.append(slime)
        return true
    return false


func release_attack_token(slime: CharacterBody2D, player_id: int) -> void:
    if player_id in _attack_tokens:
        _attack_tokens[player_id].erase(slime)


func _get_max_attackers_for_player(player_id: int) -> int:
    if player_id >= players.size():
        return base_attackers_per_player

    var info := _get_player_info(players[player_id])
    if not info:
        return base_attackers_per_player

    # –¢–∞–Ω–∫–æ–≤ –º–æ–∂–Ω–æ –∞—Ç–∞–∫–æ–≤–∞—Ç—å –±–æÃÅ–ª—å—à–∏–º —á–∏—Å–ª–æ–º ‚Äî –æ–Ω–∏ –≤—ã–¥–µ—Ä–∂–∞—Ç
    # –°—Ç–µ–∫–ª—è–Ω–Ω—ã—Ö –ø—É—à–µ–∫ ‚Äî –º–µ–Ω—å—à–∏–º (–∏ —Ç–∞–∫ –ø–æ–º—Ä—É—Ç, –∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ
    # —Å–ª–∞–π–º—ã –ø—É—Å—Ç—å –¥–∞–≤—è—Ç –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤)
    match info.player_class:
        PlayerInfo.PlayerClass.PALADIN:
            return max_attackers_per_player      # 4
        PlayerInfo.PlayerClass.WARRIOR:
            return base_attackers_per_player + 1  # 3
        PlayerInfo.PlayerClass.RANGER:
            return base_attackers_per_player       # 2
        PlayerInfo.PlayerClass.MAGE:
            return base_attackers_per_player       # 2

    return base_attackers_per_player


func _cleanup_all_tokens() -> void:
    for pid in _attack_tokens:
        _attack_tokens[pid] = _attack_tokens[pid].filter(
            func(s): return is_instance_valid(s) and s in slimes
        )

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –£–¢–ò–õ–ò–¢–´
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

func _size_to_strategy(count: int) -> Strategy:
    if count <= 2:
        return Strategy.SOLO
    elif count <= 5:
        return Strategy.PACK
    elif count <= 10:
        return Strategy.SWARM
    else:
        return Strategy.HORDE


func _get_ai(slime: CharacterBody2D) -> Node:
    if slime.has_node("SlimeAI"):
        return slime.get_node("SlimeAI")
    return null


func _get_player_info(player: CharacterBody2D) -> PlayerInfo:
    if player.has_node("PlayerInfo"):
        return player.get_node("PlayerInfo") as PlayerInfo
    return null


func _get_swarm_center() -> Vector2:
    if slimes.is_empty():
        return Vector2.ZERO
    var center := Vector2.ZERO
    for s in slimes:
        center += s.global_position
    return center / slimes.size()


## –ü–æ–ª—É—á–∏—Ç—å —Å–æ—Å–µ–¥–µ–π –∏–∑ –¢–û–ì–û –ñ–ï –û–¢–†–Ø–î–ê (–¥–ª—è cohesion/alignment)
func get_squad_neighbors(slime: CharacterBody2D, player_id: int, radius: float) -> Array[CharacterBody2D]:
    var result: Array[CharacterBody2D] = []
    var squad: Array = squads.get(player_id, [])
    var pos := slime.global_position

    for other in squad:
        if other == slime:
            continue
        if pos.distance_squared_to(other.global_position) < radius * radius:
            result.append(other)
    return result


## –ü–æ–ª—É—á–∏—Ç—å –í–°–ï–• —Å–æ—Å–µ–¥–µ–π (–¥–ª—è separation ‚Äî —á—Ç–æ–±—ã —Å–ª–∞–π–º—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö
## –æ—Ç—Ä—è–¥–æ–≤ —Ç–æ–∂–µ –Ω–µ —Å–ª–∏–ø–∞–ª–∏—Å—å –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º)
func get_all_neighbors(slime: CharacterBody2D, radius: float) -> Array[CharacterBody2D]:
    var result: Array[CharacterBody2D] = []
    var pos := slime.global_position

    for other in slimes:
        if other == slime:
            continue
        if pos.distance_squared_to(other.global_position) < radius * radius:
            result.append(other)
    return result
```

---

## –§–∞–π–ª 2 ‚Äî `slime_ai.gd` (v2)

–ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω: –∑–Ω–∞–µ—Ç —Å–≤–æ–µ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞-—Ü–µ–ª—å, –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∫ –µ–≥–æ –∫–ª–∞—Å—Å—É.

```gdscript
# scripts/enemies/slime_ai.gd
extends Node

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# –ú–û–ó–ì –°–õ–ê–ô–ú–ê v2
# –ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫ –∫–ª–∞—Å—Å—É —Ü–µ–ª–∏, —É–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç AoE,
# –∑–∏–≥–∑–∞–≥-–ø–æ–¥—Ö–æ–¥ –∫ –¥–∞–ª—å–Ω–∏–∫–∞–º
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –°–°–´–õ–ö–ò
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

var swarm: Node = null
@onready var body: CharacterBody2D = get_parent()

## –ù–∞–∑–Ω–∞—á–µ–Ω–Ω–∞—è —Ü–µ–ª—å (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∏–≥—Ä–æ–∫, –Ω–µ –æ–¥–∏–Ω –Ω–∞ –≤—Å–µ—Ö)
var assigned_target: CharacterBody2D = null

## ID –∏–≥—Ä–æ–∫–∞ –≤ –º–∞—Å—Å–∏–≤–µ SwarmManager.players
var assigned_player_id: int = 0

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ù–ê–°–¢–†–û–ô–ö–ò –î–í–ò–ñ–ï–ù–ò–Ø
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

@export var base_speed: float = 100.0
@export var dash_speed: float = 200.0
@export var separation_radius: float = 40.0
@export var neighbor_radius: float = 120.0

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ù–ê–°–¢–†–û–ô–ö–ò –†–û–õ–ï–ô
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

@export var flank_distance: float = 100.0
@export var orbit_radius: float = 150.0
@export var orbit_speed: float = 1.5
@export var retreat_distance: float = 120.0
@export var retreat_duration: float = 1.2
@export var attack_range: float = 35.0
@export var attack_cooldown: float = 1.5

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ù–ê–°–¢–†–û–ô–ö–ò –ê–î–ê–ü–¢–ê–¶–ò–ò –ö –ö–õ–ê–°–°–ê–ú
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

## –ú–Ω–æ–∂–∏—Ç–µ–ª—å –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –¥–ª—è –±–ª–∏–∂–Ω–∏—Ö –∫–ª–∞—Å—Å–æ–≤
## (–¥–µ—Ä–∂–∏–º—Å—è –¥–∞–ª—å—à–µ –æ—Ç –º–µ—á–Ω–∏–∫–∞/–ø–∞–ª–∞–¥–∏–Ω–∞)
@export var melee_distance_multiplier: float = 1.3

## –ú–Ω–æ–∂–∏—Ç–µ–ª—å –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –¥–ª—è –¥–∞–ª—å–Ω–∏—Ö –∫–ª–∞—Å—Å–æ–≤
## (–ª–µ–∑–µ–º –±–ª–∏–∂–µ –∫ –º–∞–≥—É/–ª—É—á–Ω–∏–∫—É)
@export var ranged_distance_multiplier: float = 0.8

## –ê–º–ø–ª–∏—Ç—É–¥–∞ –∑–∏–≥–∑–∞–≥–∞ –ø—Ä–∏ –ø–æ–¥—Ö–æ–¥–µ –∫ –¥–∞–ª—å–Ω–∏–∫—É
@export var zigzag_amplitude: float = 40.0

## –ß–∞—Å—Ç–æ—Ç–∞ –∑–∏–≥–∑–∞–≥–∞
@export var zigzag_frequency: float = 3.0

## –†–∞–¥–∏—É—Å —É–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –æ–ø–∞—Å–Ω—ã—Ö –∑–æ–Ω
@export var danger_avoid_radius: float = 30.0

## –°–∏–ª–∞ —É–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –æ–ø–∞—Å–Ω—ã—Ö –∑–æ–Ω
@export var danger_avoid_weight: float = 3.0

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –í–ï–°–ê BOIDS-–°–ò–õ
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

@export var weight_separation: float = 1.5
@export var weight_cohesion: float = 0.3
@export var weight_alignment: float = 0.2
@export var weight_target: float = 1.0
@export var weight_avoid_danger: float = 2.5

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –°–û–°–¢–û–Ø–ù–ò–ï
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

var current_role: int = -1
var role_index: int = 0
var flank_side: float = 1.0
var orbit_offset: float = 0.0
var personal_speed: float = 100.0

var _attack_timer: float = 0.0
var _retreat_timer: float = 0.0
var _is_retreating: bool = false
var last_direction: Vector2 = Vector2.RIGHT

## –ö—ç—à: PlayerInfo —Ü–µ–ª–∏ (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Ü–µ–ª–∏)
var _target_info: PlayerInfo = null
var _cached_target: CharacterBody2D = null

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

func _ready() -> void:
    swarm = _find_swarm_manager()
    if swarm:
        swarm.register_slime(body)
    _randomize_personality()


func _exit_tree() -> void:
    if swarm:
        swarm.unregister_slime(body)


func _randomize_personality() -> void:
    personal_speed = base_speed * randf_range(0.85, 1.15)
    orbit_offset = randf() * TAU
    flank_side = [-1.0, 1.0].pick_random()
    attack_cooldown *= randf_range(0.8, 1.2)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

func _physics_process(delta: float) -> void:
    if not swarm:
        return
    if not is_instance_valid(assigned_target):
        # –ù–µ—Ç —Ü–µ–ª–∏ ‚Äî —Å—Ç–æ–∏–º (–º–µ–Ω–µ–¥–∂–µ—Ä —Å–∫–æ—Ä–æ –Ω–∞–∑–Ω–∞—á–∏—Ç)
        body.velocity = Vector2.ZERO
        return

    # –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à PlayerInfo
    _update_target_info()

    # –¢–∞–π–º–µ—Ä—ã
    _attack_timer -= delta
    if _is_retreating:
        _retreat_timer -= delta
        if _retreat_timer <= 0.0:
            _is_retreating = false

    # ‚îÄ‚îÄ 1. –¶–µ–ª–µ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è –ø–æ —Ä–æ–ª–∏ + –∞–¥–∞–ø—Ç–∞—Ü–∏—è –∫ –∫–ª–∞—Å—Å—É ‚îÄ‚îÄ
    var target_pos := _get_role_target_position()

    # ‚îÄ‚îÄ 2. Boids-—Å–∏–ª—ã ‚îÄ‚îÄ
    # Separation ‚Äî –û–¢ –í–°–ï–• —Å–ª–∞–π–º–æ–≤ (—á—Ç–æ–±—ã —Ä–∞–∑–Ω—ã–µ –æ—Ç—Ä—è–¥—ã –Ω–µ —Å–ª–∏–ø–∞–ª–∏—Å—å)
    var all_neighbors := swarm.get_all_neighbors(body, neighbor_radius)
    var separation := _calc_separation(all_neighbors) * weight_separation

    # Cohesion + Alignment ‚Äî —Ç–æ–ª—å–∫–æ —Å—Ä–µ–¥–∏ –°–í–û–ï–ì–û –æ—Ç—Ä—è–¥–∞
    var squad_neighbors := swarm.get_squad_neighbors(
        body, assigned_player_id, neighbor_radius
    )
    var cohesion := _calc_cohesion(squad_neighbors) * weight_cohesion
    var alignment := _calc_alignment(squad_neighbors) * weight_alignment

    # ‚îÄ‚îÄ 3. –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫ —Ü–µ–ª–µ–≤–æ–π –ø–æ–∑–∏—Ü–∏–∏ ‚îÄ‚îÄ
    var to_target := Vector2.ZERO
    if body.global_position.distance_to(target_pos) > 5.0:
        to_target = (target_pos - body.global_position).normalized() * weight_target

    # ‚îÄ‚îÄ 4. –£–∫–ª–æ–Ω–µ–Ω–∏–µ –æ—Ç –æ–ø–∞—Å–Ω—ã—Ö –∑–æ–Ω ‚îÄ‚îÄ
    var danger_avoid := _calc_danger_avoidance() * weight_avoid_danger

    # ‚îÄ‚îÄ 5. –ó–∏–≥–∑–∞–≥ (–ø—Ä–æ—Ç–∏–≤ –¥–∞–ª—å–Ω–∏–∫–æ–≤) ‚îÄ‚îÄ
    var zigzag := _calc_zigzag()

    # ‚îÄ‚îÄ 6. –°—É–º–º–∏—Ä—É–µ–º ‚îÄ‚îÄ
    var desired := (
        to_target
        + separation
        + cohesion
        + alignment
        + danger_avoid
        + zigzag
    ).normalized()

    if desired.length() < 0.01:
        desired = Vector2.ZERO

    # ‚îÄ‚îÄ 7. –°–∫–æ—Ä–æ—Å—Ç—å ‚îÄ‚îÄ
    var speed := _get_current_speed()

    # ‚îÄ‚îÄ 8. –î–≤–∏–≥–∞–µ–º—Å—è ‚îÄ‚îÄ
    body.velocity = desired * speed
    body.move_and_slide()

    if desired.length() > 0.1:
        last_direction = desired

    # ‚îÄ‚îÄ 9. –ê—Ç–∞–∫–∞ ‚îÄ‚îÄ
    _try_attack()

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ê–î–ê–ü–¢–ò–í–ù–ê–Ø –¶–ï–õ–ï–í–ê–Ø –ü–û–ó–ò–¶–ò–Ø
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

func _get_role_target_position() -> Vector2:
    var player_pos: Vector2 = assigned_target.global_position
    var my_pos: Vector2 = body.global_position
    var dist_mult := _get_distance_multiplier()

    # –û—Ç—Å—Ç—É–ø–ª–µ–Ω–∏–µ
    if _is_retreating:
        var away := (my_pos - player_pos).normalized()
        return my_pos + away * retreat_distance * dist_mult

    match current_role:
        # ‚îÄ‚îÄ RUSHER ‚îÄ‚îÄ
        swarm.Role.RUSHER:
            # –ü—Ä–æ—Ç–∏–≤ –º–µ—á–Ω–∏–∫–∞: —Ü–µ–ª–∏–º—Å—è —á—É—Ç—å –ú–ò–ú–û (–Ω–µ –ø—Ä—è–º–æ –≤ –ª–æ–±)
            # –ß—Ç–æ–±—ã –Ω–µ –ø–æ–ø–∞—Å—Ç—å –ø–æ–¥ AoE —É–¥–∞—Ä
            if _target_is_melee():
                var to_player := (player_pos - my_pos)
                if to_player.length() < 1.0:
                    return player_pos
                var offset_angle := to_player.angle() + 0.3 * flank_side
                var offset_pos := player_pos + Vector2.from_angle(offset_angle) * 20.0
                return offset_pos
            else:
                # –ü—Ä–æ—Ç–∏–≤ –¥–∞–ª—å–Ω–∏–∫–∞: —Ä–∞—à–∏–º –ø—Ä—è–º–æ
                return player_pos

        # ‚îÄ‚îÄ FLANKER ‚îÄ‚îÄ
        swarm.Role.FLANKER:
            var to_player := (player_pos - my_pos)
            if to_player.length() < 1.0:
                return player_pos

            var base_angle: float = to_player.angle()
            var flank_angle: float = base_angle + (PI / 2.0) * flank_side

            # –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è —Ñ–ª–∞–Ω–≥–∞
            var adaptive_flank := flank_distance * dist_mult
            var flank_pos := player_pos + Vector2.from_angle(flank_angle) * adaptive_flank

            # –ï—Å–ª–∏ –±–ª–∏–∑–∫–æ –∫ —Ç–æ—á–∫–µ —Ñ–ª–∞–Ω–≥–∞ ‚Äî –∞—Ç–∞–∫—É–µ–º
            if my_pos.distance_to(flank_pos) < 30.0:
                return player_pos

            return flank_pos

        # ‚îÄ‚îÄ ORBITER ‚îÄ‚îÄ
        swarm.Role.ORBITER:
            var time := Time.get_ticks_msec() / 1000.0

            # –ü—Ä–æ—Ç–∏–≤ –º–µ—á–Ω–∏–∫–∞ –∫—Ä—É–∂–∏–º –î–ê–õ–¨–®–ï
            var adaptive_orbit := orbit_radius * dist_mult

            # –ü—Ä–æ—Ç–∏–≤ –¥–∞–ª—å–Ω–∏–∫–∞ –∫—Ä—É–∂–∏–º –±—ã—Å—Ç—Ä–µ–µ (—á—Ç–æ–±—ã —Å–ª–æ–∂–Ω–µ–µ –ø–æ–ø–∞—Å—Ç—å)
            var adaptive_speed := orbit_speed
            if _target_is_ranged():
                adaptive_speed *= 1.4

            var angle := time * adaptive_speed + orbit_offset
            return player_pos + Vector2.from_angle(angle) * adaptive_orbit

        # ‚îÄ‚îÄ WAITER ‚îÄ‚îÄ
        swarm.Role.WAITER:
            var to_player := (player_pos - my_pos).normalized()
            var wait_dist := orbit_radius * 1.5 * dist_mult
            return player_pos - to_player * wait_dist

        # ‚îÄ‚îÄ RETREATER ‚îÄ‚îÄ
        swarm.Role.RETREATER:
            var away := (my_pos - player_pos).normalized()
            return my_pos + away * retreat_distance

    return player_pos

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ó–ò–ì–ó–ê–ì (–ü–†–û–¢–ò–í –î–ê–õ–¨–ù–ò–ö–û–í)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ö–æ–≥–¥–∞ —Å–ª–∞–π–º –±–µ–∂–∏—Ç –∫ –ª—É—á–Ω–∏–∫—É/–º–∞–≥—É, –æ–Ω –¥–≤–∏–≥–∞–µ—Ç—Å—è –≤–æ–ª–Ω–æ–π,
# —á—Ç–æ–±—ã –≤ –Ω–µ–≥–æ –±—ã–ª–æ —Å–ª–æ–∂–Ω–µ–µ –ø–æ–ø–∞—Å—Ç—å —Å–Ω–∞—Ä—è–¥–∞–º–∏.

func _calc_zigzag() -> Vector2:
    if not _target_is_ranged():
        return Vector2.ZERO

    # –ó–∏–≥–∑–∞–≥ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞—à–µ—Ä–æ–≤ –∏ —Ñ–ª–∞–Ω–∫–µ—Ä–æ–≤
    if current_role != swarm.Role.RUSHER and current_role != swarm.Role.FLANKER:
        return Vector2.ZERO

    # –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–ª–µ–∫–æ (–≤–±–ª–∏–∑–∏ –∑–∏–≥–∑–∞–≥ –Ω–µ –Ω—É–∂–µ–Ω)
    var dist := body.global_position.distance_to(assigned_target.global_position)
    if dist < 60.0:
        return Vector2.ZERO

    # –ü–µ—Ä–ø–µ–Ω–¥–∏–∫—É–ª—è—Ä –∫ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –Ω–∞ —Ü–µ–ª—å
    var to_target := (assigned_target.global_position - body.global_position).normalized()
    var perpendicular := Vector2(-to_target.y, to_target.x)

    # –°–∏–Ω—É—Å–æ–∏–¥–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ (—É –∫–∞–∂–¥–æ–≥–æ —Å–ª–∞–π–º–∞ —Å–≤–æ–π orbit_offset,
    # –ø–æ—ç—Ç–æ–º—É –∑–∏–≥–∑–∞–≥–∏ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã)
    var time := Time.get_ticks_msec() / 1000.0
    var zigzag_value := sin(time * zigzag_frequency + orbit_offset) * zigzag_amplitude

    # –û—Å–ª–∞–±–ª—è–µ–º –∑–∏–≥–∑–∞–≥ —Å –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ–º
    var dist_factor := clampf(dist / 200.0, 0.0, 1.0)

    return perpendicular * zigzag_value * dist_factor * 0.01

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –£–ö–õ–û–ù–ï–ù–ò–ï –û–¢ –û–ü–ê–°–ù–´–• –ó–û–ù
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –°–ª–∞–π–º—ã –≤–∏–¥—è—Ç, –∫–æ–≥–¥–∞ –∏–≥—Ä–æ–∫ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å,
# –∏ —É–±–µ–≥–∞—é—Ç –∏–∑ –∑–æ–Ω—ã –ø–æ—Ä–∞–∂–µ–Ω–∏—è.

func _calc_danger_avoidance() -> Vector2:
    var force := Vector2.ZERO
    var my_pos := body.global_position

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –í–°–ï –æ–ø–∞—Å–Ω—ã–µ –∑–æ–Ω—ã –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
    # (–Ω–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ–π —Ü–µ–ª–∏ ‚Äî —á—É–∂–æ–π –º–∞–≥ —Ç–æ–∂–µ –º–æ–∂–µ—Ç –∫–∞—Å—Ç–∞–Ω—É—Ç—å –º–µ—Ç–µ–æ—Ä–∏—Ç —Ä—è–¥–æ–º)
    for player in swarm.players:
        var info := _get_info_for(player)
        if not info or not info.is_ability_active:
            continue

        var zone_center := info.ability_zone_center
        var zone_radius := info.ability_zone_radius + danger_avoid_radius

        var dist := my_pos.distance_to(zone_center)

        if dist < zone_radius and dist > 0.01:
            # –£–±–µ–≥–∞–µ–º –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –∑–æ–Ω—ã
            var away := (my_pos - zone_center).normalized()

            # –ß–µ–º –±–ª–∏–∂–µ –∫ —Ü–µ–Ω—Ç—Ä—É ‚Äî —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –ø–∞–Ω–∏–∫–∞
            var urgency := clampf(1.0 - (dist / zone_radius), 0.0, 1.0)

            # –©–∏—Ç –ø–∞–ª–∞–¥–∏–Ω–∞ ‚Äî –æ—Å–æ–±—ã–π —Å–ª—É—á–∞–π: —Å–ª–∞–π–º—ã –≤–æ–æ–±—â–µ –Ω–µ –ª–µ–∑—É—Ç –≤ –∑–æ–Ω—É
            if info.ability_type == "shield":
                urgency *= 2.0

            force += away * urgency

    return force.normalized() if force.length() > 0.01 else Vector2.ZERO

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# BOIDS
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

func _calc_separation(neighbors: Array[CharacterBody2D]) -> Vector2:
    var force := Vector2.ZERO
    var my_pos := body.global_position

    for other in neighbors:
        var diff := my_pos - other.global_position
        var dist := diff.length()
        if dist < separation_radius and dist > 0.01:
            force += diff.normalized() * (separation_radius / dist)

    return force.normalized() if force.length() > 0.01 else Vector2.ZERO


func _calc_cohesion(neighbors: Array[CharacterBody2D]) -> Vector2:
    if neighbors.is_empty():
        return Vector2.ZERO

    var center := Vector2.ZERO
    for other in neighbors:
        center += other.global_position
    center /= neighbors.size()

    var to_center := center - body.global_position
    return to_center.normalized() if to_center.length() > 1.0 else Vector2.ZERO


func _calc_alignment(neighbors: Array[CharacterBody2D]) -> Vector2:
    if neighbors.is_empty():
        return Vector2.ZERO

    var avg_vel := Vector2.ZERO
    var count := 0
    for other in neighbors:
        if other.velocity.length() > 1.0:
            avg_vel += other.velocity.normalized()
            count += 1

    if count == 0:
        return Vector2.ZERO

    avg_vel /= count
    return avg_vel.normalized()

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ê–¢–ê–ö–ê
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

func _try_attack() -> void:
    if _attack_timer > 0.0 or _is_retreating:
        return
    if not _is_in_attack_range():
        return

    # –ü—Ä–æ—Å–∏–º —Ç–æ–∫–µ–Ω –¥–ª—è –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –∏–≥—Ä–æ–∫–∞
    if not swarm.request_attack_token(body, assigned_player_id):
        return

    _perform_attack()


func _perform_attack() -> void:
    # –£—Ä–æ–Ω —á–µ—Ä–µ–∑ HealthComponent
    if assigned_target.has_node("HealthComponent"):
        assigned_target.get_node("HealthComponent").take_damage(10)

    _attack_timer = attack_cooldown
    swarm.release_attack_token(body, assigned_player_id)
    _start_retreat()


func _start_retreat() -> void:
    _is_retreating = true
    _retreat_timer = retreat_duration

    # –ü—Ä–æ—Ç–∏–≤ –±–ª–∏–∂–Ω–∏–∫–∞ ‚Äî –æ—Ç—Å—Ç—É–ø–∞–µ–º –¥–æ–ª—å—à–µ –∏ –¥–∞–ª—å—à–µ
    if _target_is_melee():
        _retreat_timer *= 1.3

    flank_side *= -1.0

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –°–ö–û–†–û–°–¢–¨
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

func _get_current_speed() -> float:
    var speed := personal_speed

    # –†–∞—à–µ—Ä —É—Å–∫–æ—Ä—è–µ—Ç—Å—è –≤–±–ª–∏–∑–∏ —Ü–µ–ª–∏
    if current_role == swarm.Role.RUSHER:
        var dist := body.global_position.distance_to(assigned_target.global_position)
        if dist < swarm.close_range * 1.5:
            speed = dash_speed

    # –ü—Ä–æ—Ç–∏–≤ –¥–∞–ª—å–Ω–∏–∫–∞: –±–∞–∑–æ–≤–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å —á—É—Ç—å –≤—ã—à–µ (–Ω—É–∂–Ω–æ –¥–æ–±–µ–∂–∞—Ç—å)
    if _target_is_ranged():
        speed *= 1.1

    # –û—Ç—Å—Ç—É–ø–ª–µ–Ω–∏–µ —á—É—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ
    if _is_retreating:
        speed *= 0.8

    # Waiter –¥–≤–∏–≥–∞–µ—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω–æ
    if current_role == swarm.Role.WAITER:
        speed *= 0.6

    return speed

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ê–î–ê–ü–¢–ò–í–ù–´–ï –ú–ù–û–ñ–ò–¢–ï–õ–ò
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

## –ú–Ω–æ–∂–∏—Ç–µ–ª—å –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –ø–æ –∫–ª–∞—Å—Å—É —Ü–µ–ª–∏
func _get_distance_multiplier() -> float:
    if _target_is_melee():
        return melee_distance_multiplier    # 1.3 ‚Äî –¥–µ—Ä–∂–∏–º—Å—è –¥–∞–ª—å—à–µ
    elif _target_is_ranged():
        return ranged_distance_multiplier   # 0.8 ‚Äî –ª–µ–∑–µ–º –±–ª–∏–∂–µ
    return 1.0

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –£–¢–ò–õ–ò–¢–´
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

func _target_is_melee() -> bool:
    return _target_info != null and _target_info.is_melee()

func _target_is_ranged() -> bool:
    return _target_info != null and _target_info.is_ranged()

func _is_in_attack_range() -> bool:
    if not is_instance_valid(assigned_target):
        return false
    return body.global_position.distance_to(
        assigned_target.global_position
    ) < attack_range

func _update_target_info() -> void:
    if assigned_target != _cached_target:
        _cached_target = assigned_target
        _target_info = _get_info_for(assigned_target)

func _get_info_for(player: CharacterBody2D) -> PlayerInfo:
    if is_instance_valid(player) and player.has_node("PlayerInfo"):
        return player.get_node("PlayerInfo") as PlayerInfo
    return null

func set_role(role: int, index: int = 0) -> void:
    current_role = role
    role_index = index
    flank_side = 1.0 if index % 2 == 0 else -1.0

    # –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –æ—Ä–±–∏—Ç—ã
    var squad_size := 1
    if swarm and assigned_player_id in swarm.squads:
        squad_size = maxi(swarm.squads[assigned_player_id].size(), 1)
    orbit_offset = (index * TAU) / squad_size

func _find_swarm_manager() -> Node:
    var managers := get_tree().get_nodes_in_group("swarm_manager")
    if managers.size() > 0:
        return managers[0]
    var root := get_tree().current_scene
    if root.has_node("SwarmManager"):
        return root.get_node("SwarmManager")
    push_warning("SwarmManager not found!")
    return null
```

---

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç: 4 –∏–≥—Ä–æ–∫–∞, 12 —Å–ª–∞–π–º–æ–≤

```
THREAT CALCULATION (–ø—Ä–∏–º–µ—Ä):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ò–≥—Ä–æ–∫   ‚îÇ Dist ‚îÇ Kills ‚îÇ HP%    ‚îÇ Class  ‚îÇ THREAT  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ –ú–∞–≥      ‚îÇ 0.7  ‚îÇ 0.8   ‚îÇ 0.6    ‚îÇ 1.0    ‚îÇ  4.22   ‚îÇ
‚îÇ –õ—É—á–Ω–∏–∫   ‚îÇ 0.5  ‚îÇ 0.4   ‚îÇ 0.2    ‚îÇ 0.8    ‚îÇ  2.46   ‚îÇ
‚îÇ –ú–µ—á–Ω–∏–∫   ‚îÇ 0.9  ‚îÇ 0.2   ‚îÇ 0.1    ‚îÇ 0.5    ‚îÇ  1.82   ‚îÇ
‚îÇ –ü–∞–ª–∞–¥–∏–Ω  ‚îÇ 0.3  ‚îÇ 0.0   ‚îÇ 0.0    ‚îÇ 0.3    ‚îÇ  0.66   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–ú–∞–≥ ‚Äî –≥–ª–∞–≤–Ω–∞—è —É–≥—Ä–æ–∑–∞ (–º–Ω–æ–≥–æ —É–±–∏–≤–∞–µ—Ç + —Å—Ç–µ–∫–ª—è–Ω–Ω—ã–π)
```

```
SQUAD DISTRIBUTION (–ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ threat):
  –ú–∞–≥      ‚Üí 5 —Å–ª–∞–π–º–æ–≤ (46%)   Strategy: PACK
  –õ—É—á–Ω–∏–∫   ‚Üí 3 —Å–ª–∞–π–º–∞  (27%)   Strategy: PACK
  –ú–µ—á–Ω–∏–∫   ‚Üí 3 —Å–ª–∞–π–º–∞  (20%)   Strategy: PACK
  –ü–∞–ª–∞–¥–∏–Ω  ‚Üí 1 —Å–ª–∞–π–º   (7%)    Strategy: SOLO
```

```
VS –ú–ê–ì (5 —Å–ª–∞–π–º–æ–≤, PACK, target_is_ranged = true):
    role_plan = [RUSHER, RUSHER, RUSHER, FLANKER, FLANKER]
    
            F‚ÇÑ (–∑–∏–≥–∑–∞–≥–æ–º –∑–∞—Ö–æ–¥–∏—Ç —Å–±–æ–∫—É)
           ‚ï±
    R‚ÇÅ ‚îÄ‚îÄ‚âà‚Üí üîÆ –ú–∞–≥  ‚Üê‚âà‚îÄ‚îÄ R‚ÇÇ    (—Ä–∞—à–µ—Ä—ã –∑–∏–≥–∑–∞–≥–æ–º –≤ –ª–æ–±)
         ‚Üë        ‚ï≤
    R‚ÇÉ ‚îÄ‚âà‚Üí        F‚ÇÖ (—Å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã)
    
    ‚âà = –∑–∏–≥–∑–∞–≥-–¥–≤–∏–∂–µ–Ω–∏–µ (—Å–ª–æ–∂–Ω–µ–µ –ø–æ–ø–∞—Å—Ç—å —Å–Ω–∞—Ä—è–¥–æ–º)
    3 —Ä–∞—à–µ—Ä–∞ –¥–∞–≤—è—Ç, 2 —Ñ–ª–∞–Ω–∫–µ—Ä–∞ –æ–±—Ö–æ–¥—è—Ç
    –î–∏—Å—Ç–∞–Ω—Ü–∏–∏ —Å–∂–∞—Ç—ã (√ó0.8) ‚Äî –ª–µ–∑—É—Ç –ë–õ–ò–ñ–ï


VS –ú–ï–ß–ù–ò–ö (3 —Å–ª–∞–π–º–∞, PACK, target_is_melee = true):
    role_plan = [RUSHER, FLANKER, ORBITER]
    
         O‚ÇÉ (–∫—Ä—É–∂–∏—Ç –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏)
        ‚ï±
    R‚ÇÅ ‚Üí ‚öîÔ∏è –ú–µ—á–Ω–∏–∫    ‚Üê F‚ÇÇ (–æ–±—Ö–æ–¥–∏—Ç —Å–∑–∞–¥–∏)
    
    –†–∞—à–µ—Ä –ø–æ–¥—Ö–æ–¥–∏—Ç –Ω–µ –≤ –ª–æ–±, –∞ —á—É—Ç—å —Å–æ —Å–º–µ—â–µ–Ω–∏–µ–º
    –í—Å–µ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ —É–≤–µ–ª–∏—á–µ–Ω—ã (√ó1.3) ‚Äî –¥–µ—Ä–∂–∞—Ç—Å—è –¥–∞–ª—å—à–µ
    –û—Ç—Å—Ç—É–ø–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∞—Ç–∞–∫–∏ –¥–æ–ª—å—à–µ (√ó1.3)


VS –ü–ê–õ–ê–î–ò–ù (1 —Å–ª–∞–π–º, SOLO, target_is_melee = true):
    role_plan = [FLANKER]
    
    F‚ÇÅ ‚ï≠‚îÄ‚Üí üõ°Ô∏è –ü–∞–ª–∞–¥–∏–Ω
       ‚ï∞‚îÄ‚îÄ‚ïÆ  (–∫—Ä—É–∂–∏—Ç, –∂–¥—ë—Ç –º–æ–º–µ–Ω—Ç)
           ‚Üì
    
    –û–¥–∏–Ω —Å–ª–∞–π–º –ø—Ä–æ—Å—Ç–æ –¥–µ—Ä–∂–∏—Ç –¥–∏—Å—Ç–∞–Ω—Ü–∏—é
    –î–∞–∂–µ –Ω–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç ‚Äî –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞–≤—è—Ç –º–∞–≥–∞ –∏ –ª—É—á–Ω–∏–∫–∞
```

```
–†–ï–ê–ö–¶–ò–Ø –ù–ê –°–ü–û–°–û–ë–ù–û–°–¢–ò:

1) –ú–∞–≥ –∫–∞—Å—Ç—É–µ—Ç –º–µ—Ç–µ–æ—Ä–∏—Ç:
    üîÆ ‚Üí activate_danger_zone(pos, 120, "ranged_aoe")
    
    –í—Å–µ —Å–ª–∞–π–º—ã –í –†–ê–î–ò–£–°–ï 150 (120 + 30 avoid):
    ‚Üê‚Üê‚Üê –£–ë–ï–ì–ê–Æ–¢ –û–¢ –¶–ï–ù–¢–†–ê ‚Üí‚Üí‚Üí
    (–¥–∞–∂–µ —Ç–µ, –∫—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤)

2) –ú–µ—á–Ω–∏–∫ –¥–µ–ª–∞–µ—Ç –∫—Ä—É–≥–æ–≤–æ–π —É–¥–∞—Ä:
    ‚öîÔ∏è ‚Üí activate_danger_zone(pos, 80, "melee_aoe")
    
    –°–ª–∞–π–º—ã –≤–±–ª–∏–∑–∏: ‚Üê‚Üê –û–¢–°–ö–ê–ö–ò–í–ê–Æ–¢ ‚Üê‚Üê
    –û—Ä–±–∏—Ç–µ—Ä—ã: –∏ —Ç–∞–∫ –¥–∞–ª–µ–∫–æ, –Ω–µ —Ä–µ–∞–≥–∏—Ä—É—é—Ç

3) –ü–∞–ª–∞–¥–∏–Ω —Å—Ç–∞–≤–∏—Ç –∫—É–ø–æ–ª:
    üõ°Ô∏è ‚Üí activate_danger_zone(pos, 100, "shield")
    
    urgency √ó 2.0 ‚Äî —Å–ª–∞–π–º—ã –í–û–û–ë–©–ï –Ω–µ –ª–µ–∑—É—Ç –≤ –∑–æ–Ω—É
    (—â–∏—Ç –∏ —Ç–∞–∫ –∑–∞—â–∏—â–∞–µ—Ç, –Ω–µ—á–µ–≥–æ –ª–æ–º–∏—Ç—å—Å—è)
```

---

## –°—Ü–µ–Ω–∞ –∏–≥—Ä–æ–∫–∞ (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)

```
Player (CharacterBody2D) [warrior.gd / mage.gd / ...]
‚îú‚îÄ‚îÄ CollisionShape2D
‚îú‚îÄ‚îÄ Sprite2D
‚îú‚îÄ‚îÄ PlayerInfo (Node) [player_info.gd]    ‚Üê –ù–û–í–´–ô –ö–û–ú–ü–û–ù–ï–ù–¢
‚îÇ   ‚îî‚îÄ‚îÄ player_class = WARRIOR (–∑–∞–¥–∞—Ç—å –≤ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–µ)
‚îú‚îÄ‚îÄ HealthComponent (Node)
‚îú‚îÄ‚îÄ HurtboxComponent (Area2D)
‚îú‚îÄ‚îÄ HitboxComponent (Area2D)
‚îî‚îÄ‚îÄ StateMachine (Node)
```

–í `PlayerInfo` –≤ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–µ –≤—ã—Å—Ç–∞–≤–ª—è–µ—à—å `player_class` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Å–∞ –∏ –ø—Ä–æ–ø–∏—Å—ã–≤–∞–µ—à—å –ø—É—Ç—å –∫ `HealthComponent`.

---

## –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –ø–æ –±–∞–ª–∞–Ω—Å—É

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ü–∞—Ä–∞–º–µ—Ç—Ä           ‚îÇ –≠—Ñ—Ñ–µ–∫—Ç                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ threat_weight_     ‚îÇ –ú–µ–Ω—è–µ—Ç, –∫–æ–≥–æ —Å–ª–∞–π–º—ã –∞—Ç–∞–∫—É—é—Ç –ø–µ—Ä–≤—ã–º.     ‚îÇ
‚îÇ damage = 3.0       ‚îÇ –í—ã—Å–æ–∫–∏–π ‚Üí —Å—Ç–∞—è –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ —Ç–æ–≥–æ,   ‚îÇ
‚îÇ                    ‚îÇ –∫—Ç–æ —É–±–∏–≤–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Å–µ—Ö.                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ threat_weight_     ‚îÇ –í—ã—Å–æ–∫–∏–π ‚Üí –¥–æ–±–∏–≤–∞—é—Ç —Ä–∞–Ω–µ–Ω—ã—Ö.             ‚îÇ
‚îÇ low_hp = 0.5       ‚îÇ –ù–∏–∑–∫–∏–π ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç –ø–æ–ª—É–º—ë—Ä—Ç–≤—ã—Ö.        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ min_squad_size     ‚îÇ 1 = –ø–∞–ª–∞–¥–∏–Ω –º–æ–∂–µ—Ç –æ—Å—Ç–∞—Ç—å—Å—è –±–µ–∑ –≤–Ω–∏–º–∞–Ω–∏—è. ‚îÇ
‚îÇ                    ‚îÇ 2 = –Ω–∞ –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –º–∏–Ω–∏–º—É–º 2 —Å–ª–∞–π–º–∞. ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ reassign_interval  ‚îÇ 0.3 = —Å–ª–∞–π–º—ã –±—ã—Å—Ç—Ä–æ –ø–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è.    ‚îÇ
‚îÇ                    ‚îÇ 1.0 = –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –Ω–æ –º–µ–Ω–µ–µ "—á–∏—Ç–µ—Ä–Ω–æ".    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ zigzag_amplitude   ‚îÇ –ë–æ–ª—å—à–µ ‚Üí —Å–ª–æ–∂–Ω–µ–µ –ø–æ–ø–∞—Å—Ç—å –∏–∑ –ª—É–∫–∞/–º–∞–≥–∏–∏. ‚îÇ
‚îÇ                    ‚îÇ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ ‚Üí —Å–ª–∞–π–º—ã –µ–ª–µ –ø–æ–ª–∑—É—Ç.      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ melee_distance_    ‚îÇ 1.5 ‚Üí —Å–ª–∞–π–º—ã –æ—á–µ–Ω—å –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã —Å –º–µ—á–Ω–∏–∫–æ–º.‚îÇ
‚îÇ multiplier         ‚îÇ 1.1 ‚Üí –ø–æ—á—Ç–∏ –Ω–µ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è.              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ß–µ–∫–ª–∏—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

```
 1. –î–æ–±–∞–≤—å PlayerInfo.gd –∫–∞–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∫ –∫–∞–∂–¥–æ–º—É –∫–ª–∞—Å—Å—É –∏–≥—Ä–æ–∫–∞
 2. –í—ã—Å—Ç–∞–≤–∏ player_class –≤ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä–µ (WARRIOR/RANGER/MAGE/PALADIN)
 3. –ü—Ä–æ–ø–∏—à–∏ health_component_path (–æ–±—ã—á–Ω–æ "HealthComponent" –∏–ª–∏ "../HealthComponent")
 4. –í —Å–∫—Ä–∏–ø—Ç–∞—Ö —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π –≤—ã–∑—ã–≤–∞–π activate/deactivate_danger_zone
 5. –î–æ–±–∞–≤—å SwarmManager (Node) –≤ –∫–æ—Ä–µ–Ω—å –∏–≥—Ä–æ–≤–æ–π —Å—Ü–µ–Ω—ã
 6. –î–æ–±–∞–≤—å –µ–≥–æ –≤ –≥—Ä—É–ø–ø—É "swarm_manager"
 7. –ö–∞–∂–¥—ã–π —Å–ª–∞–π–º –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –¥–æ—á–µ—Ä–Ω–∏–π SlimeAI (Node) —Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º slime_ai.gd
 8. –ò–≥—Ä–æ–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –≥—Ä—É–ø–ø–µ "player"
 9. –£ HealthComponent –Ω—É–∂–µ–Ω –º–µ—Ç–æ–¥ get_hp_ratio() –∏–ª–∏ –ø–æ–ª—è hp/max_hp
10. –ü—Ä–∏ —Å–º–µ—Ä—Ç–∏ —Å–ª–∞–π–º–∞ ‚Äî –≤—ã–∑–≤–∞—Ç—å player_info.register_kill()
    —É –∏–≥—Ä–æ–∫–∞-—É–±–∏–π—Ü—ã (–¥–ª—è threat-—Å–∏—Å—Ç–µ–º—ã)
```

–ü—É–Ω–∫—Ç 10 ‚Äî –≤ `health_component.gd` –ø—Ä–∏ —Å–º–µ—Ä—Ç–∏:

```gdscript
# health_component.gd
signal died(killed_by: CharacterBody2D)

func take_damage(amount: int, source: CharacterBody2D = null) -> void:
    hp -= amount
    if hp <= 0:
        hp = 0
        died.emit(source)
```

```gdscript
# slime.gd
func _ready() -> void:
    $HealthComponent.died.connect(_on_died)

func _on_died(killed_by: CharacterBody2D) -> void:
    # –°–æ–æ–±—â–∞–µ–º —É–±–∏–π—Ü–µ –¥–ª—è threat-—Å–∏—Å—Ç–µ–º—ã
    if is_instance_valid(killed_by) and killed_by.has_node("PlayerInfo"):
        killed_by.get_node("PlayerInfo").register_kill()
    queue_free()
```